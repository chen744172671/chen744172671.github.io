---
title: "JVM"
date: 2023-04-13 13:35:03-23:00
last_modified_at: 2023-05-04 21:50:09-23:00
categories:
  - JAVA
---

JVM:

	内存模型
		堆heap
			对象的实例或者数组
				只有一个堆，被所有的线程共享，是不连续的内存空间
				会被垃圾回收器进一步划分-新生代、老年代
				会导致内存泄漏
		栈stack
			存放基本数据类型、对象的引用地址(指向对象的实例)
				先进后出，连续的内存空间，每个线程都会创建一个栈针
				每个方法执行都会创建一个栈针(存储局部变量，操作数等)
		方法区(堆heap)
			运行时常量池、类的方法、构造器、静态属性和方法
				存放不变或者唯一的内容
	内存管理
		把对象赋值为null即可(Io流、数据库连接、网络连接等无法自动回收)，STW(stop the World)
		垃圾回收算法：引用计数法、引用可达法(根搜索法)、标记-清除（复制）算法、三色标记算法
		分代垃圾回收(减少Full GC-JVM调优的目标)
			年轻代
				一个Eden区(存储新对象)，如果满了会触发Minor GC，清理无用对象，
				把有用对象对象复制到survivor区
				2个survivor区(存放垃圾回收后仍然存在的对象，循环存放<=15次)
			年老代(存放>15次的对象)-Major GC清理老年代
			永久代(元数据空间)
		查看堆栈dump
			jstack -F PID 强制打印堆栈信息到标准输出
			kill -3 PID 打印当时线程堆栈和堆内存使用概要
			-XX:+HeapDumpOnOutOfMemoryError 当出现内存溢出时自动生成堆dump文件
			jmap -dump:live,format=b,file=FILE_WITH_PATH PID 把堆中存活的对象输出到指定文件
			jmap -F -heap PID 查看指定JVM 进程的堆的信息，包括堆的各个参数的值，
			堆中新生代、年老代的内存大小、使用率等
			jmap -F -histo PID获取堆中类实例统计，以占用内存的大小排序
		内存分析
			 java_pid*.hprof内存快照文件 用于分析 OOM 
				​Eclipse Memory Analyzer Tool（MAT）分析内存泄漏​
		命令
			 -Xss:每个线程的栈大小(默认1M,可改成256K)
			 -Xms:初始堆大小，默认物理内存的1/64
			 -Xmx:最大堆大小，默认物理内存的1/4
			 -Xmn:新生代大小
			 -XX:NewSize:设置新生代初始大小
			 -XX:NewRatio:默认2表示新生代占年老代的1/2，占整个堆内存的1/3。
			 -XX:SurvivorRatio:默认8表示一个survivor区占用1/8的Eden内存，即1/10的新生代内存。
			 -XX:MetaspaceSize:设置元空间大小
			 -XX:MaxMetaspaceSize:设置元空间最大允许大小，默认不受限制，JVM Metaspace会进行动态扩展。
			-XX:+PrintGCDetails 打印垃圾回收统计信息
		垃圾收集器
			串行收集器
				进行垃圾收集时，必须暂停其他所有工作线程，直到它收集结束
					应用在内存资源受限或者单核处理器、处理器核心较少的环境，可以获得最高的单线程收集效率
			并行收集器
				多线程并行收集，用户线程是处于等待状态
			Parallel Scavenge收集器
				自适应调节策略
					-XX:MaxGCPauseMillis参数（最大停顿时间）
					-XX:GCTimeRatio（吞吐量）
			CMS收集器
				并发收集，低停顿，只用于老年代中，标记-清除算法(垃圾处理线程与用户线程同时工作，
				但由于垃圾收集器线程占用了一部分系统资源，用户线程处理的吞吐量将受到一定影响。)
				初始标记-并发标记-重新标记-并发清除
			G1收集器
				逻辑分代+物理分区回收(每个分区大小为堆空间总大小%2048)，只有G1区和元空间，面向全堆收集
				优先回收价值收益最大的Region
				由用户指定期望的停顿时间(默认200ms)
				内存占用和额外执行负载都比CMS高，适用于大内存(6G-8G)
				初始标记-并发标记-最终标记-筛选回收(STAB + 写屏障)
			ZGC低延迟垃圾收集器
				不分代，触发产生的停顿时间不会偏差10ms(都不会受到堆空间大小的影响)
				分为小型区/页(Small)-固定大小为2MB-用于分配小于256KB的对象、
				Medium-固定大小为32MB-用于分配>=256KB ~ <=4MB的对象、Large-专门用于存放一个>4MB的巨型对象
				能自动感知NUMA架构并充分利用NUMA（非统一内存访问）架构特性
				 基于64位指针实现的染色指针技术，标记的是指针而并非对象，最大能够支持16TB堆内存
				并发标记-并发转移准备-并发转移-并发重映射/定位((读屏障))
			ShenandoahGC
				不分代，将堆内存划分为一个个大小相同的Region区域
				基于转发指针实现
				初始标记-并发标记-最终标记-并发回收(读+写屏障)
			Epsilon收集器
				用于程序上线前做性能测试、内存压力测试、VM接口测试使用
	
